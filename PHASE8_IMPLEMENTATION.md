# Phase 8: Knowledge Capture & Reuse Implementation

**Status**: ✅ Foundation Complete

This document summarizes Phase 8's implementation: structured insight capture, AI-assisted extraction (supervised), human review & promotion, and systematic knowledge reuse.

---

## Overview

Phase 8 ensures:
- **Knowledge must be structured** → KnowledgeItem8 with detailed content blocks
- **Capture at natural moments** → Debriefs trigger on project completion
- **Reuse is the default** → Knowledge suggestions when building proposals
- **AI assists, humans approve** → AI generates candidates; staff/admin review & promote
- **Knowledge is contextual** → Tagged by service suite, industry, proposal type

---

## Architecture

### Data Models (Firestore)

```
orgs/{orgId}/
  knowledge/
    {knowledgeId}              → KnowledgeItem8 (approved insight)
  knowledgeCandidates/
    {candidateId}              → KnowledgeCandidate8 (AI-generated, pending review)
  knowledgeUsage/
    {usageId}                  → KnowledgeUsage8 (where knowledge is applied)

projects/{projectId}/
  debriefs/
    {debriefId}                → Debrief8 (post-engagement reflection)
```

#### KnowledgeItem8 (Approved Knowledge)
- **Type**: playbook, framework, pattern, diagnostic, caution
- **Confidence progression**: draft → validated → proven (one-way only)
- **Structured content**: whatThisIs, whenToUseIt, signals, steps, caveats (not one blob)
- **Tags**: serviceSuites, industries, proposalTypes (for discovery)
- **Source tracking**: sourceProjects, createdBy, reviewedBy, approvedAt
- **Usage metrics**: usageCount, lastUsedAt, linkedOutcomes

```typescript
interface KnowledgeItem8 {
  id: string;
  title: string;
  type: 'playbook' | 'framework' | 'pattern' | 'diagnostic' | 'caution';
  summary: string;
  detailedContent: {
    whatThisIs?: string;
    whenToUseIt?: string;
    whenNotToUseIt?: string;
    signals?: string[];
    steps?: string[];
    examples?: string[];
    caveats?: string[];
  };
  confidenceLevel: 'draft' | 'validated' | 'proven'; // only increases
  usageCount?: number;
  lastUsedAt?: Timestamp;
  linkedOutcomes?: Array<{ projectId; outcome: 'success' | 'failure' | 'partial' }>;
  archivedAt?: Timestamp; // soft delete
}
```

#### Debrief8 (Post-Engagement Capture)
- **Triggered automatically** when project status → completed (Phase 8.3)
- **Free-text reflection** on what worked, what didn't, unexpected issues, patterns
- **Links to candidates**: extractedCandidateIds (when AI extracts insights)
- **Required before archival** (non-negotiable)

```typescript
interface Debrief8 {
  id: string;
  projectId: string;
  whatWorked: string;
  whatDidNotWork: string;
  unexpectedIssues?: string;
  patternsObserved?: string;
  frameworksUsed?: string[];
  wouldDoDifferentlyNextTime?: string;
  reusableInsights?: string;
  submittedBy: string;
  extractedCandidateIds?: string[]; // AI-generated candidates
}
```

#### KnowledgeCandidate8 (AI-Generated, Awaiting Review)
- **Generated by AI** via `extractKnowledgeCandidates()` (Phase 8.4)
- **Status workflow**: pending-review → approved → linked to KnowledgeItem8
- **Never published directly**: Human review & edits required
- **Always starts draft confidence**: "This is interesting, but unvalidated"

```typescript
interface KnowledgeCandidate8 {
  id: string;
  sourceDebriefId?: string;
  sourceProjectId?: string;
  title: string;
  type: KnowledgeType8;
  summary: string;
  status: 'pending-review' | 'approved' | 'rejected';
  reviewedBy?: string;
  rejectionReason?: string;
  approvedKnowledgeId?: string; // if promoted
}
```

#### KnowledgeUsage8 (Reuse Tracking)
- **Records where knowledge is applied**: proposal, project, deliverable, decision
- **Usage types**: reference, adapted, quoted
- **Auto-triggers** when knowledge linked to proposals
- **Feeds metrics**: usageCount, lastUsedAt on KnowledgeItem8

```typescript
interface KnowledgeUsage8 {
  id: string;
  knowledgeId: string;
  usedIn: 'proposal' | 'project' | 'deliverable' | 'decision';
  usedInId: string;
  usageType: 'reference' | 'adapted' | 'quoted';
  createdAt: Timestamp;
}
```

#### KnowledgeHealthCheck
- **Triggered monthly** by `checkKnowledgeHealth()` (Phase 8.8)
- **Flags unused knowledge** (90+ days) for reassessment
- **Flags associated failures** (if linked projects had issues)
- **Suggests actions**: review, consolidate, archive

---

## Implementation

### 1. Type Definitions (`src/types/phase8-models.ts`)
- ✅ Separate file for Phase 8 types (doesn't pollute main data-models.ts)
- ✅ KnowledgeItem8, Debrief8, KnowledgeCandidate8, KnowledgeUsage8
- ✅ KnowledgeHealthCheck for monitoring

### 2. Knowledge Helpers (`src/lib/knowledge.ts`)
Server-side functions implementing Phase 8 workflow:

#### Debrief Capture
- `submitDebrief()` → creates Debrief8 + activity timeline

#### Knowledge Management
- `createKnowledgeFromCandidate()` → promotes candidate to KnowledgeItem8
- `promoteConfidenceLevel()` → draft → validated → proven (one-way enforcement)
- `archiveKnowledge()` → soft delete (retention for history)

#### Usage Tracking
- `recordKnowledgeUsage()` → tracks where knowledge is used
- Auto-updates usageCount & lastUsedAt on KnowledgeItem8

#### Candidate Workflow
- `createKnowledgeCandidate()` → human-drafted or AI-generated
- `rejectKnowledgeCandidate()` → with rationale

#### Health Monitoring
- `flagUnusedKnowledge()` → checks if unused > 90 days
- `assessKnowledgeWithFailures()` → checks for associated failures

### 3. Server Actions (`src/app/projects/actions.ts`)
Next.js server actions wired to knowledge helpers:

```typescript
// Debriefs
export async function captureDebrief(orgId, projectId, payload, formData)

// Knowledge approval & lifecycle
export async function promoteCandidateToKnowledge(orgId, candidateId, payload, formData)
export async function promoteKnowledgeConfidence(orgId, knowledgeId, newLevel, formData)
export async function archiveKnowledgeItem(orgId, knowledgeId, formData)

// Usage & reuse
export async function recordUsage(orgId, knowledgeId, payload, formData)

// Candidate workflow
export async function draftKnowledgeCandidate(orgId, payload, formData)
export async function rejectCandidate(orgId, candidateId, rejectionReason, formData)
```

### 4. Cloud Functions (`functions/src/phase8.ts`)

#### Phase 8.4: AI-Assisted Extraction (Callable)
**Function**: `extractKnowledgeCandidates`
- **Trigger**: Staff/admin calls manually after debrief submission
- **Input**: orgId, projectId, debriefId
- **AI does**: 
  - Reads debrief + project context
  - Generates 2-4 knowledge candidate ideas
  - Saves as pending-review candidates (never published)
- **Output**: candidateIds, count
- **Rule**: AI always outputs draft confidence only

**Prompt strategy**:
```
Analyze this project debrief for reusable insights.
Extract patterns, frameworks, diagnostics, or cautions worth capturing.
Suggest 2-4 knowledge items (not generic).
Each item must have clear signals, steps, and caveats.
```

#### Phase 8.3: Auto-Debrief Trigger
**Function**: `onProjectCompleted`
- **Trigger**: When project.status → completed
- **Action**: Log activity prompt "Debrief required" if none exists yet
- **Purpose**: Surface debrief workflow (non-blocking)

#### Phase 8.7: Usage Tracking
**Function**: `onProposalWithKnowledge`
- **Trigger**: When proposal created with linkedKnowledgeIds
- **Action**: Records usage in knowledgeUsage for each linked item
- **Updates**: usageCount & lastUsedAt on KnowledgeItem8

#### Phase 8.8: Health Monitoring (Scheduled)
**Function**: `checkKnowledgeHealth`
- **Schedule**: Monthly (every 30 days)
- **Checks**:
  - Unused >90 days → flag for review
  - Associated failures → flag for reassessment
  - Stores checks as sub-docs under knowledge/{knowledgeId}/healthChecks

#### Audit Logging
- `onKnowledgeItemCreated()` → logs knowledge creation
- `onDebriefSubmitted()` → logs debrief submission
- `onCandidateReviewed()` → logs candidate approval/rejection

---

## Workflow Examples

### Example 1: Project Completes → Debrief → Knowledge Extraction

1. **Project completed** (status → completed)
2. → `onProjectCompleted` fires: logs activity "Debrief required"
3. **Staff submits debrief**: calls `captureDebrief()`
   - What worked: "Incremental delivery approach kept client engaged"
   - What didn't: "Scope creep from unclear requirements initially"
   - Would do differently: "More formal sign-off gates"
4. **Admin triggers AI extraction**: calls `extractKnowledgeCandidates(orgId, projectId, debriefId)`
5. **AI generates candidates** (draft confidence):
   - **Playbook**: "Incremental Delivery Checkpoints"
   - **Caution**: "Red flags for scope creep"
   - **Framework**: "Requirements sign-off gates"
6. **Admin reviews queue** → sees 3 candidates (pending-review)
7. **Admin edits + approves** first two:
   - Edits: refines wording, adds examples
   - Approves: `promoteCandidateToKnowledge()`
   - → Creates KnowledgeItem8 (draft confidence)
8. **Rejects third**: "Too generic, skip"
9. **Promotes to validated**: After confirming with team, `promoteKnowledgeConfidence(knowledgeId, 'validated')`
10. **Next proposal** for similar client: System suggests "Incremental Delivery Checkpoints"
11. **Staff reuses**: Links knowledge → records usage

### Example 2: Confidence Promotion (Proven)

1. **"Incremental Delivery" knowledge** (currently validated, used 3× successfully)
2. **Admin reviews usage**: All 3 proposals won; no failures
3. **Promotes to proven**: `promoteKnowledgeConfidence('incremental-delivery', 'proven')`
4. **Effect**: Knowledge now appears at top of search; "trusted" signal in proposals

### Example 3: Health Monitoring Flags

1. **Monthly job** `checkKnowledgeHealth` runs
2. **"Legacy Pattern X"** not used for 120 days
3. → Flagged: "unused_threshold" → suggests review
4. **Admin action**: Either
   - Reuse it (removes flag)
   - Archive it (`archiveKnowledge()`)
   - Update it if out-of-date
5. **"Risky Framework"** linked to 2 failed projects
6. → Flagged: "associated_failures" → suggests reassess
7. **Admin action**: Review rationale, then
   - Adjust framework
   - Archive if no longer applicable
   - Link positive outcomes if context was wrong

---

## Key Rules (Non-Negotiable)

### Confidence Progression
- ✅ draft → validated (one-way)
- ✅ validated → proven (one-way)
- ❌ Can never decrease (no demotions)
- ❌ Can never skip steps (no draft → proven directly)

### AI Boundaries
- ✅ AI generates candidates
- ❌ AI never publishes directly
- ✅ AI always outputs draft confidence only
- ❌ No unsupervised knowledge creation
- ✅ Human edits before approval

### Reuse Defaults
- ✅ Knowledge searchable by type, service, industry, proposal type
- ✅ Linked knowledge shown in proposal builder
- ✅ Usage recorded automatically
- ❌ No knowledge without source attribution

### Archive, Don't Delete
- ✅ Old/outdated knowledge archived (soft delete)
- ✅ History retained for audit trails
- ❌ No permanent deletion

---

## Permissions & Visibility

| Role | Can Submit Debrief | Can Review Candidates | Can Promote Confidence | Can Archive | Can View All |
|------|---|---|---|---|---|
| **Client** | ❌ No | ❌ No | ❌ No | ❌ No | ❌ No |
| **Staff** | ✅ Yes | ✅ Yes (draft) | ❌ No | ❌ No | ✅ Yes |
| **Admin** | ✅ Yes | ✅ Yes (all) | ✅ Yes | ✅ Yes | ✅ Yes |

---

## Audit Trail (Integration with Phase 7.8)

Every action logs to auditLogs:

```
eventType: 'debrief_submitted' | 'knowledge_item_created' | 'candidate_approved' | 'candidate_rejected'
actor: userId
targetType: 'debrief' | 'knowledge' | 'knowledge_candidate'
timestamp: Timestamp
```

Feeds:
- **Governance**: Complete trail of what thinking was captured and approved
- **Accountability**: Who made knowledge decisions
- **Reuse metrics**: What knowledge was used where

---

## Integration with Other Phases

### Phase 6 (Delivery)
- Debrief captures: frameworks used, client behaviours, unexpected issues
- Red flags inform debrief reflection

### Phase 7 (Governance)
- Risk decisions linked to decisions
- Change outcomes inform knowledge health assessment

### Phase 4 (AI)
- AI assists extraction (on a leash)
- Knowledge informs proposal generation

### Future: Phase 11 (Operating Rhythm)
- Monthly knowledge health review digest
- "Most valuable knowledge" report
- Confidence promotion recommendations

---

## Quick Start: Using Phase 8

### For Staff (Capturing & Reviewing)

```typescript
// 1. Submit debrief after project completion
const { id: debriefId } = await captureDebrief(orgId, projectId, {
  whatWorked: 'Client-driven iterations kept scope tight',
  whatDidNotWork: 'Initial requirements gathering too rushed',
  unexpectedIssues: 'Third-party API delays',
  patternsObserved: 'Scope creep triggers: unclear acceptance criteria',
  wouldDoDifferentlyNextTime: 'Formal sign-off gate after requirements phase',
}, formData);

// 2. Trigger AI extraction (optional, or skip for manual drafting)
const { candidateIds } = await extractKnowledgeCandidates({
  orgId, projectId, debriefId
}, context);  // Call via Cloud Function

// 3. Review candidates in UI
// Shows: pending-review candidates with AI-generated content
// Edit, then:

// 4. Approve candidate → promote to knowledge
const { id: knowledgeId } = await promoteCandidateToKnowledge(orgId, candidateId, {
  title: 'Requirements Sign-Off Gates (Edited)',
  type: 'framework',
  summary: 'Gate-based approach to requirements validation',
  detailedContent: { /* edited content */ },
  serviceSuites: ['Stabilise & Recover'],
}, formData);

// 5. Use in next proposal
// When building proposal: system suggests "Requirements Sign-Off Gates"
// Staff links it: records usage automatically

// 6. Later: Promote to validated (after ≥1 successful use)
await promoteKnowledgeConfidence(orgId, knowledgeId, 'validated', formData);
```

### For Admin (Governance & Promotion)

```typescript
// Archive unused/outdated knowledge
await archiveKnowledgeItem(orgId, knowledgeId, formData);

// Promote proven knowledge (used ≥2 proposals, all successful)
await promoteKnowledgeConfidence(orgId, knowledgeId, 'proven', formData);

// Health check alerts show which knowledge needs attention:
// → "Requirements Sign-Off" unused 120+ days
// → "Risky Pattern" linked to 2 failures
// Action on each as needed
```

### For Proposals (Reuse)

```typescript
// When building proposal, system shows:
// Suggested Knowledge (by service, industry, proposal type):
// - "Incremental Delivery Checkpoints" (proven)
// - "Requirements Sign-Off Gates" (validated)
// - "Scope Creep Red Flags" (draft)

// Staff selects → links knowledge
// Proposal records linkedKnowledgeIds

// On save: usage recorded automatically
```

---

## Completion Checklist

Phase 8 is **✅ foundationally complete** when:

- [x] Every completed project can generate structured debrief
- [x] Debriefs can be reflected on (free-text capture)
- [x] AI extracts candidates (supervised, draft-only)
- [x] Humans review & edit candidates
- [x] Candidates promoted to knowledge (validated/proven progression)
- [x] Knowledge searchable by type, service, industry, proposal type
- [x] Knowledge reusable in proposals (suggestions + linking)
- [x] Usage tracked automatically
- [x] Confidence can increase (one-way)
- [x] Health checks flag unused/failed knowledge
- [x] Complete audit trail of all knowledge actions

**Next steps** (UI Layer):
- Build debrief capture form (post-project workflow)
- Build knowledge candidate review dashboard
- Build knowledge library (filterable search)
- Proposal builder: suggest relevant knowledge
- Admin dashboard: health check alerts + promotion queue
- Monthly digest: "Most used knowledge" + "Confidence promotions"

---

## Files Modified

| File | Change |
|------|--------|
| `src/types/phase8-models.ts` | New: KnowledgeItem8, Debrief8, Candidate8, Usage8 types |
| `src/lib/knowledge.ts` | New: Core Phase 8 functions (capture, extraction, review, promotion, usage) |
| `src/app/projects/actions.ts` | Added Phase 8 server actions |
| `functions/src/phase8.ts` | New: AI extraction (callable), auto-triggers, health monitoring, audit logging |
| `functions/src/index.ts` | Imported and exported Phase 8 functions |

---

## The Honest Truth

Phase 8 is where your **unfair advantage** lives.

Anyone can:
- Write proposals
- Deliver projects
- Build portals

Almost no one systematically:
- **Captures thinking properly** (structured, not scattered notes)
- **Validates it** (human review before reuse)
- **Reuses it** (linked into proposals, not forgotten)
- **Tracks which insights actually work** (metrics + health monitoring)

This phase quietly widens the gap every month you use it. Six months in, your proposals will subtly be better. Twelve months in, you'll feel patterns forming. Two years in, competitors will wonder how you're so consistent.

**The system does the learning, not just the people.**

---

## References

- **Phase 8 Spec**: See user attachment (this implementation)
- **Data Models**: orgs → [knowledge, knowledgeCandidates, knowledgeUsage]
- **Triggers**: projects → debriefs (manual), AI extraction (callable)
- **Audit**: Every action in auditLogs collection
- **Integration**: Feeds Phase 11 operating rhythm
